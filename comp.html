<!DOCTYPE html>
<html>
  <head>
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script>
      // Global variable to hold the alpha value (direction to the magnetic North)
      let alphaToNorth = null;

      AFRAME.registerComponent('abs-orientation', {
        init: function () {
          var camera = this.el;
          
          var handleOrientation = function (event) {
            alphaToNorth = event.alpha;
            var beta = event.beta;
            var gamma = event.gamma;
            camera.setAttribute('rotation', {x: beta, y: alphaToNorth, z: gamma});
          };

          var requestPermission = function () {
            if (typeof DeviceOrientationEvent.requestPermission === 'function') {
              DeviceOrientationEvent.requestPermission()
                .then(function (response) {
                  if (response === 'granted') {
                    window.addEventListener('deviceorientationabsolute', handleOrientation, true);
                  } else {
                    alert('Permission not granted.');
                  }
                })
                .catch(function (error) {
                  alert('An error occurred: ' + error);
                });
            } else {
              // For browsers that don't require permission
              window.addEventListener('deviceorientationabsolute', handleOrientation, true);
            }
          };

          var button = document.createElement('button');
          button.innerHTML = 'Request Device Orientation Permission';
          button.style.position = 'absolute';
          button.style.zIndex = '1';
          button.onclick = requestPermission;
          document.body.appendChild(button);
        },
      });

      AFRAME.registerComponent('face-north', {
        tick: function() {
          if (alphaToNorth !== null) {
            this.el.setAttribute('rotation', {x: 0, y: -alphaToNorth, z: 0});
          }
        }
      });
    </script>
  </head>
  <body>
    <a-scene>
      <a-entity camera abs-orientation></a-entity>
      <a-box id="northBox" position="-1 0.5 -3" rotation="0 0 0" color="#4CC3D9"></a-box>
      <a-sphere position="0 1.25 -5" radius="1.25" color="#EF2D5E"></a-sphere>
      <a-cylinder position="1 0.75 -3" radius="0.5" height="1.5" color="#FFC65D"></a-cylinder>
      <a-plane position="0 0 -4" rotation="-90 0 0" width="4" height="4" color="#7BC8A4"></a-plane>
      <a-sky color="#ECECEC"></a-sky>
    </a-scene>
  </body>
</html>
