<!DOCTYPE html>
<html>
<head>
  <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
  <script>
    AFRAME.registerComponent('alignment', {
      schema: {
        north: {type: 'boolean', default: false},
        time: {type: 'number', default: 0}
      },
      init: function () {
        if (this.data.north) {
          requestPermission().then(() => {
            if (this.data.time > 0) {
              setTimeout(() => {
                window.addEventListener('deviceorientation', this.handleOrientation, true);
              }, this.data.time * 1000);
            } else {
              window.addEventListener('deviceorientation', this.handleOrientation, true);
            }
          });
        }
        this.handleOrientation = this.handleOrientation.bind(this);
        this.adjustCompass = this.adjustCompass.bind(this);
      },
      handleOrientation: function(event) {
        var compassHeading = event.webkitCompassHeading || 360 - event.alpha;
        var windowOrientation = window.orientation || 0;
        var adjustedCompassHeading = this.adjustCompass(compassHeading, windowOrientation);
        
        this.el.setAttribute('rotation', {x: 0, y: adjustedCompassHeading, z: 0});
        
        // Remove the event listener after one measurement
        window.removeEventListener('deviceorientation', this.handleOrientation);
      },
      adjustCompass: function(compassHeading, windowOrientation) {
        var adjustedCompassHeading = compassHeading;
        if (windowOrientation === 90) {
          adjustedCompassHeading = (compassHeading - 90 + 360) % 360;
        } else if (windowOrientation === -90) {
          adjustedCompassHeading = (compassHeading + 90) % 360;
        }
        return adjustedCompassHeading;
      }
    });

    async function requestPermission() {
      if (typeof DeviceOrientationEvent.requestPermission === 'function') {
        const permission = await DeviceOrientationEvent.requestPermission();
        if (permission === 'granted') {
          console.log('Berechtigung erteilt');
          return true;
        } else {
          console.log('Berechtigung nicht erteilt');
          return false;
        }
      } else {
        console.log("Diese Anwendung muss auf den Kompass Ihres Ger√§ts zugreifen. Bitte erlauben Sie den Zugriff, wenn Sie dazu aufgefordert werden.");
        return true;
      }
    }
  </script>
</head>
<body>
  <a-scene>
    <a-entity geometry="primitive: box" material="color: blue" alignment="north: true; time: 5;">
      <a-box position="0 0 10" color="red"></a-box>
    </a-entity>
    <a-box position="0 0 10" color="blue"></a-box>
    <a-camera position="0 0 0"></a-camera>
  </a-scene>
</body>
</html>
