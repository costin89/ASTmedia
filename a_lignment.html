<!DOCTYPE html>
<html>
<head>
  <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
  <script>
    let measureCounter = 0;

    AFRAME.registerComponent('alignment', {
      schema: {
        north: {type: 'boolean', default: false},
        measure: {type: 'int', default: 1}
      },
      init: function () {
        if (this.data.north) {
          requestPermission();
        }
        this.handleOrientation = this.handleOrientation.bind(this);
        this.adjustCompass = this.adjustCompass.bind(this);
        window.addEventListener('deviceorientation', this.handleOrientation, true);
      },
      remove: function () {
        window.removeEventListener('deviceorientation', this.handleOrientation);
      },
      handleOrientation: function(event) {
        measureCounter++;
        
        if (measureCounter <= this.data.measure) {
          var compassHeading = event.webkitCompassHeading || 360 - event.alpha;
          var windowOrientation = window.orientation || 0;
          var adjustedCompassHeading = this.adjustCompass(compassHeading, windowOrientation);
          
          this.el.setAttribute('rotation', {x: 0, y: adjustedCompassHeading, z: 0});
        }
      },
      adjustCompass: function(compassHeading, windowOrientation) {
        var adjustedCompassHeading = compassHeading;
        if (windowOrientation === 90) {
          adjustedCompassHeading = (compassHeading - 90 + 360) % 360;
        } else if (windowOrientation === -90) {
          adjustedCompassHeading = (compassHeading + 90) % 360;
        }
        return adjustedCompassHeading;
      }
    });

    async function requestPermission() {
      if (typeof DeviceOrientationEvent.requestPermission === 'function') {
        const permission = await DeviceOrientationEvent.requestPermission();
        if (permission === 'granted') {
          console.log('Berechtigung erteilt');
        } else {
          console.log('Berechtigung nicht erteilt');
        }
      } else {
        console.log("Diese Anwendung muss auf den Kompass Ihres GerÃ¤ts zugreifen. Bitte erlauben Sie den Zugriff, wenn Sie dazu aufgefordert werden.");
      }
    }
  </script>
</head>
<body>
  <a-scene>
    <a-entity geometry="primitive: box" material="color: blue" alignment="north: true; measure: 2;"></a-entity>
    <a-camera position="0 2 5"></a-camera>
  </a-scene>
</body>
</html>
