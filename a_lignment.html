<!DOCTYPE html>
<html>
<head>
  <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
  <script>
    AFRAME.registerComponent('alignment', {
      schema: {
        north: { type: 'boolean', default: false },
        measure: { type: 'int', default: 1 },
        time: { type: 'int', default: 0 }
      },
      init: function () {
        if (this.data.north) {
          requestPermission().then(() => {
            let scene = document.querySelector('a-scene');
            if (scene.hasLoaded) {
              this.startMeasurement();
            } else {
              scene.addEventListener('loaded', this.startMeasurement.bind(this));
            }
          });
        }
      },
      startMeasurement: function () {
        setTimeout(() => {
          this.measurementsLeft = this.data.measure;
          window.addEventListener('deviceorientation', this.handleOrientation);
        }, this.data.time * 1000);
      },
      handleOrientation: function(event) {
        var compassHeading = event.webkitCompassHeading || 360 - event.alpha;
        var windowOrientation = window.orientation || 0;
        var adjustedCompassHeading = this.adjustCompass(compassHeading, windowOrientation);

        this.el.setAttribute('rotation', {x: 0, y: adjustedCompassHeading, z: 0});
        
        this.measurementsLeft--;
        if (this.measurementsLeft <= 0) {
          window.removeEventListener('deviceorientation', this.handleOrientation);
        }
      },
      adjustCompass: function(compassHeading, windowOrientation) {
        var adjustedCompassHeading = compassHeading;
        if (windowOrientation === 90) {
          adjustedCompassHeading = (compassHeading - 90 + 360) % 360;
        } else if (windowOrientation === -90) {
          adjustedCompassHeading = (compassHeading + 90) % 360;
        }
        return adjustedCompassHeading;
      }
    });

    async function requestPermission() {
      if (typeof DeviceOrientationEvent.requestPermission === 'function') {
        const permission = await DeviceOrientationEvent.requestPermission();
        if (permission !== 'granted') {
          console.log('Berechtigung nicht erteilt');
        }
      } else {
        console.log("Diese Anwendung muss auf den Kompass Ihres GerÃ¤ts zugreifen. Bitte erlauben Sie den Zugriff, wenn Sie dazu aufgefordert werden.");
      }
    }
  </script>
</head>
<body>
  <a-scene>
    <a-entity geometry="primitive: box" material="color: blue" alignment="north: true; measure: 2; time: 5;">
      <a-box position="0 0 10" color="red"></a-box>
    </a-entity>
    <a-box position="0 0 10" color="blue"></a-box>
    <a-camera position="0 0 0"></a-camera>
  </a-scene>
</body>
</html>
